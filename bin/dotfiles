#!/bin/sh

ask() {
  printf "$1 [y/N] "
  read answer
  return `[ "$answer" = y ] || [ "$answer" = Y ]`
}

if [ "`pwd`" != "/home/`whoami`" ]; then
  if ! ask >&2 "You are in `pwd`! Really continue?"; then
    echo >&2 "Aborted."
    exit
  fi
fi

if ! `which home-manager &>/dev/null` && \
  ! ask >&2 "home-manger not found. Continue?"; then
  echo >&2 "Aborted."
  exit
fi

src="$1"
if [ -z "$src" ]; then
  src="/data/`whoami`"
fi

for file in $src/.*; do
  basename="`basename $file`"
  if [ "$basename" != "." ] && \
     [ "$basename" != ".." ] && \
     [ "$basename" != ".hg" ] && \
     [ "$basename" != ".hgsub" ] && \
     [ "$basename" != ".hgsubstate" ] && \
     [ "$basename" != ".hgtags" ]; then
    echo "`basename $file` <- $file"
    if [ -e "./$basename" ] && `ask >&2 "Overwrite?"`; then
      ln -sf "$file"
    else
      ln -s "$file"
    fi
  fi
done

home-manager switch
