#!/bin/sh

ask() {
  printf "$1 [y/N] "
  read
  return `[ "$REPLY" = y ] || [ "$REPLY" = Y ]`
}

files="$1"
if [ ! -e "$files" ]; then
  # resolve default file list
  if [ -L "$0" ]; then
    files="`readlink \"$0\"`"
  else
    files="$0"
  fi
  files="`dirname \"$files\"`/../.dotfiles"
  files="`realpath \"$files\"`"
fi

pager() {
  if [ -n "$PAGER" ]; then
    printf "$PAGER"
  else
    printf less
  fi
}

link() {
  local file="$1"
  local src="`dirname \"$files\"`"

  printf "$src/$file"
  printf >&2 "..."

  local skip=false
  if [ ! -e "$file" ] && [ ! -L "$file" ]; then
    mkdir -p "`dirname \"$file\"`"
    printf >&2 " OK"
    echo
  else
    if [ `realpath "$file"` = `realpath "$src/$file"` ]; then
      local skip=true
      printf >&2 " OK"
      echo
    else
      echo >&2 " File exists"
      ls >&2 -lah "$file"

      printf >&2 "View/Diff? [v/d] "
      read
      if [ "$REPLY" = "v" ]; then
        `pager` "$file"
      elif [ "$REPLY" = "d" ]; then
        diff -ry --suppress-common-lines "$file" "$src/$file" | `pager`
      fi

      if ask >&2 "Overwrite?"; then
        rm -r "`realpath \"$file\"`"
      else
        local skip=true
      fi
    fi
  fi

  if [ "$skip" = false ]; then
    ln -s "$src/$file" "$file"
  fi
}

if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  echo "Usage: `basename $0` [filelist]"
  echo "The default filelist is $files."
  exit 0
fi

if cd "$HOME"; then
  while read -u 10 -r file; do
    link "$file"
  done 10< "$files"
fi
