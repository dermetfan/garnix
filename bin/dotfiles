#!/bin/sh

ask() {
  printf "$1 [y/N] "
  read
  return `[ "$REPLY" = y ] || [ "$REPLY" = Y ]`
}

WHOAMI="`whoami`"

if [ "`pwd`" != "`eval echo ~$WHOAMI`" ]; then
  if ! ask >&2 "You are in `pwd`! Really continue?"; then
    echo >&2 "Aborted."
    exit
  fi
fi

files="$1"
if [ ! -f "$files"  ]; then
  files="`realpath /data/$WHOAMI/.dotfiles`"
fi

link() {
  local file="$1"
  local src="`dirname $files`"

  printf "$src/$file\n"

  if [ ! -e "$file" ]; then
    mkdir -p "`dirname $file`"
    ln -s "$src/$file" "$file"
  elif ask >&2 "File exists. Overwrite?"; then
    ln -sf "$src/$file" "$file"
  fi
}

while read -u 10 -r file; do
  link "$file"
done 10< "$files"
